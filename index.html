<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tina — Auto Verify (embedded, downloads ready)</title>
<style>
  :root{{--bg:#0b0b0f;--fg:#f5f5f7;--muted:#b9b9c0;--card:#121219;--red:#ef4444;--outline:#6b7280;--ok:#22c55e;--warn:#f59e0b;}}
  html,body{{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;line-height:1.45}}
  .wrap{{max-width:980px;margin:0 auto;padding:20px 14px 64px}}
  h1{{margin:0 0 8px;font-size:clamp(22px,4vw,34px)}}
  p.big{{margin:0 0 10px;color:var(--muted);font-size:clamp(16px,2.6vw,20px)}}
  .card{{background:var(--card);border:2px solid var(--outline);border-radius:16px;padding:16px;margin:18px 0;box-shadow:0 6px 18px rgba(0,0,0,.35)}}
  .pill{{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--outline);border-radius:999px;padding:6px 10px;margin:4px 8px 0 0;color:var(--muted);font-size:14px}}
  .dot{{width:10px;height:10px;border-radius:50%;background:#ef4444}} .ok{{background:var(--ok)}} .warnc{{background:var(--warn)}}
  button{{cursor:pointer;border:none;border-radius:14px;padding:14px 18px;font-size:18px;font-weight:700}}
  .primary{{background:var(--red);color:#fff;box-shadow:0 6px 14px rgba(239,68,68,.3)}}
  .secondary{{background:#1f2937;color:#fff;border:2px solid var(--outline)}}
  button:disabled{{opacity:.6;cursor:not-allowed}}
  pre{{white-space:pre-wrap;word-break:break-word;font-size:14px}}
  .mono{{font-family:ui-monospace,Menlo,Consolas,monospace;word-break:break-all}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Auto Verify (Sourcify)</h1>
  <p class="big">This page compiles your embedded Solidity, then automatically verifies on Polygon. When done, you can download <b>metadata.json</b> and <b>ABI.json</b>.</p>

  <div class="card">
    <div class="pill"><span id="dotCompile" class="dot"></span> Compile</div>
    <div class="pill"><span id="dotMeta" class="dot"></span> Metadata ready</div>
    <div class="pill"><span id="dotVerify" class="dot"></span> Sourcify verify</div>
    <div class="pill"><span id="dotDone" class="dot"></span> Done</div>
  </div>

  <div class="card">
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <button id="downloadMeta" class="secondary" disabled>Download metadata.json</button>
      <button id="downloadAbi" class="secondary" disabled>Download ABI.json</button>
      <button id="statusBtn" class="secondary">Check Status</button>
      <button id="speakBtn" class="secondary">Read Aloud</button>
      <button id="copyBtn" class="secondary">Copy Response</button>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px">Output</h2>
    <pre id="out">Preparing…</pre>
  </div>
</div>

<script id="embeddedSources" type="application/json">
{embedded_sources_json}
</script>

<script>
const ADDRESS = "0xCdb25eb86266cAA0C175144eF4FB241A2F79390E"; // Tina
const CHAIN = "137"; // Polygon Mainnet
const COMPILERS = ["v0.8.30+commit.73712a01","v0.8.26+commit.8a97fa7a","v0.8.24+commit.e11b9ed9","v0.8.20+commit.a1b79de6"];

const out = document.getElementById("out");
function setOut(obj){{ out.textContent = (typeof obj === "string") ? obj : JSON.stringify(obj,null,2); }}
function dot(id, ok){{ const el = document.getElementById(id); el.className = "dot " + (ok?"ok":""); }}
function say(text){{ try{{ const u=new SpeechSynthesisUtterance(text); u.rate=.95; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{{}} }}

let metadataBlob=null, abiBlob=null, sourcesForUpload=[];

async function loadSolc(v){{
  const url = "https://binaries.soliditylang.org/bin/soljson-" + v + ".js";
  const res = await fetch(url); if(!res.ok) throw new Error("Failed to fetch "+v);
  const js = await res.text();
  const blob = new Blob([js], {{type:"text/javascript"}});
  const blobURL = URL.createObjectURL(blob);
  await new Promise((resolve,reject)=>{{ const s=document.createElement("script"); s.src=blobURL; s.onload=resolve; s.onerror=()=>reject(new Error("solc load failed")); document.head.appendChild(s); }});
  if(!window.solc) throw new Error("solc missing");
  return window.solc;
}}

function makeStdJson(sources){{
  const srcs = {{}}; Object.keys(sources).forEach(p=>srcs[p]={{content:sources[p]}});
  return {{
    language:"Solidity",
    settings:{{
      optimizer:{enabled:true, runs:200},
      metadata:{useLiteralContent:true},
      outputSelection:{"*":{"*":["abi","evm.bytecode","evm.deployedBytecode","metadata"]}}
    }},
    sources: srcs
  }};
}

async function autoRun(){{
  try{{
    // 1) Load sources
    const sources = JSON.parse(document.getElementById("embeddedSources").textContent);
    // 2) Load a compiler that works
    setOut("Loading compiler…");
    let solc=null, used=null, lastErr=null;
    for(const v of COMPILERS){{
      try{{ solc = await loadSolc(v); used=v; break; }}catch(e){{ lastErr=e; }}
    }}
    if(!solc) throw lastErr || new Error("No compiler available");
    // 3) Compile
    setOut({{step:"compile", compiler:used}});
    const input = makeStdJson(sources);
    const output = JSON.parse(solc.compile(JSON.stringify(input)));
    if(output.errors){{
      const errs = output.errors.filter(e=>e.severity==="error");
      if(errs.length){{ setOut(output.errors); say("Compile error."); return; }}
    }}
    dot("dotCompile", true);
    // 4) Extract first metadata + ABI
    let meta=null, abi=null;
    const file = Object.keys(output.contracts)[0];
    if(file){{
      const map = output.contracts[file];
      for(const name in map){{
        if(map[name].metadata){{ meta = map[name].metadata; }}
        if(map[name].abi){{ abi = JSON.stringify(map[name].abi, null, 2); }}
        if(meta && abi) break;
      }}
    }}
    if(!meta) throw new Error("No metadata produced");
    metadataBlob = new Blob([meta], {{type:"application/json"}});
    abiBlob = new Blob([abi || "[]"], {{type:"application/json"}});
    document.getElementById("downloadMeta").disabled = false;
    document.getElementById("downloadAbi").disabled = false;
    dot("dotMeta", true);
    // Prepare sources
    sourcesForUpload = Object.keys(sources).map(p=>({{name:p, blob:new Blob([sources[p]], {{type:"text/plain"}})}}));
    // 5) Auto-verify
    setOut({{step:"verify", note:"Sending metadata + sources to Sourcify…"}});
    const fd = new FormData();
    fd.append("address", ADDRESS);
    fd.append("chain", CHAIN);
    fd.append("files", metadataBlob, "metadata.json");
    for(const s of sourcesForUpload){{ fd.append("files", s.blob, s.name); }}
    const res = await fetch("https://sourcify.dev/server/verify/files", {{method:"POST", body:fd}});
    const data = await res.json().catch(()=>({{status:res.status, text:"Non-JSON response"}}));
    dot("dotVerify", true);
    setOut(data);
    say("Verification step completed.");
    dot("dotDone", true);
  }}catch(e){{
    setOut({{error:String(e)}});
    say("There was an error.");
  }}
}}

document.getElementById("downloadMeta").addEventListener("click", ()=>{{
  if(!metadataBlob) return;
  const a = document.createElement("a");
  a.href = URL.createObjectURL(metadataBlob);
  a.download = "metadata.json"; document.body.appendChild(a); a.click(); a.remove();
}});
document.getElementById("downloadAbi").addEventListener("click", ()=>{{
  if(!abiBlob) return;
  const a = document.createElement("a");
  a.href = URL.createObjectURL(abiBlob);
  a.download = "ABI.json"; document.body.appendChild(a); a.click(); a.remove();
}});
document.getElementById("statusBtn").addEventListener("click", async()=>{{
  try{{
    const url = `https://sourcify.dev/server/check-all-by-addresses?addresses=${{ADDRESS}}&chainIds=${{CHAIN}}`;
    const r = await fetch(url); setOut(await r.json());
  }}catch(e){{ setOut({{error:String(e)}}); }}
}});
document.getElementById("copyBtn").addEventListener("click", async()=>{{
  try{{ await navigator.clipboard.writeText(out.textContent||""); alert("Copied."); }}catch(e){{ alert("Copy failed: "+e); }}
}});
document.getElementById("speakBtn").addEventListener("click", ()=>say(out.textContent||"No response yet."));

// run on load
document.addEventListener("DOMContentLoaded", autoRun);
</script>
</body>
</html>
