<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>One‑Click Verify (Sourcify • Polygon)</title>
<style>
  :root { --bg:#0b0b0b; --fg:#f1f1f1; --muted:#bdbdbd; --accent:#7c9cff; --ok:#29c060; --err:#ff6b6b; }
  html,body{background:var(--bg);color:var(--fg);font:18px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0}
  .wrap{max-width:820px;margin:24px auto;padding:16px}
  h1{font-size:28px;margin:0 0 8px}
  .card{border:1px solid #222;border-radius:14px;padding:14px;margin:12px 0;background:#111}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,textarea{width:100%;background:#0f0f0f;color:var(--fg);border:1px solid #222;border-radius:10px;padding:12px;font-size:18px}
  textarea{min-height:260px;resize:vertical;white-space:pre; overflow:auto}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  button{width:100%;padding:14px 16px;border:0;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer}
  .primary{background:var(--accent);color:#000}
  .secondary{background:#222}
  .ok{color:var(--ok);font-weight:700}
  .err{color:var(--err);font-weight:700}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:16px}
  .muted{color:var(--muted)}
  .tiny{font-size:14px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a1a1a;border:1px solid #222;margin-left:8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Verify Contract on Polygon (Sourcify)</h1>
    <div class="card tiny muted">
      Tip: Put this <strong>index.html</strong> and your <strong>AssetsAlertNFT_FINAL_FIXED.sol</strong> (flattened) in the same GitHub folder. When this page loads, it will auto‑pull the Solidity file and fill it below.
    </div>

    <div class="card">
      <label for="address">Contract Address</label>
      <input id="address" class="mono" value="0xd7375FCe805Be8ca059c7B3f641F5c14e833469f" />

      <div class="row">
        <div>
          <label for="chain">Chain</label>
          <select id="chain">
            <option value="137" selected>Polygon Mainnet (137)</option>
            <option value="80002">Amoy Testnet (80002)</option>
          </select>
        </div>
        <div>
          <label for="compiler">Compiler Version</label>
          <select id="compiler">
            <option value="v0.8.30+commit.73712a01" selected>v0.8.30+commit.73712a01</option>
          </select>
        </div>
      </div>

      <label for="contractName">Contract Name (as in source)</label>
      <input id="contractName" class="mono" value="MyMultiToken" />

      <label for="sol">Flattened Solidity (auto‑loaded)</label>
      <textarea id="sol" class="mono" placeholder="Loading AssetsAlertNFT_FINAL_FIXED.sol ..."></textarea>

      <div class="row" style="margin-top:10px">
        <button id="verifyBtn" class="primary">Verify with Sourcify</button>
        <button id="checkBtn" class="secondary">Check Status</button>
      </div>

      <div id="result" class="mono" style="margin-top:12px;white-space:pre-wrap"></div>
    </div>

    <div class="card tiny muted">
      <div><strong>How it works</strong></div>
      <ol>
        <li>This page <em>fetches</em> <span class="mono">AssetsAlertNFT_FINAL_FIXED.sol</span> from the same folder.</li>
        <li>When you click <em>Verify</em>, it sends a multipart request to <span class="mono">https://sourcify.dev/server/verify</span> with your address, chain, compiler, and the file contents.</li>
        <li>Click <em>Check Status</em> to see if Sourcify matched your on‑chain bytecode (perfect/partial).</li>
      </ol>
    </div>
  </div>

<script>
(async function boot(){
  const solArea = document.getElementById('sol');
  try {
    // Load flattened file that sits NEXT TO this index.html
    const resp = await fetch('AssetsAlertNFT_FINAL_FIXED.sol', {cache:'no-store'});
    if (!resp.ok) throw new Error('Could not load AssetsAlertNFT_FINAL_FIXED.sol');
    solArea.value = await resp.text();
  } catch (e) {
    solArea.value = `// Could not auto-load AssetsAlertNFT_FINAL_FIXED.sol\n// Put the flattened file next to index.html or paste it here.\n\n/* Error: ${e.message} */\n`;
  }
})();

function ui(msg, cls){
  const el = document.getElementById('result');
  el.className = 'mono ' + (cls||'');
  el.textContent = msg;
}

async function verifyWithSourcify(){
  const address   = document.getElementById('address').value.trim();
  const chain     = document.getElementById('chain').value.trim();
  const compiler  = document.getElementById('compiler').value.trim();
  const name      = document.getElementById('contractName').value.trim();
  const source    = document.getElementById('sol').value;

  if (!/^0x[0-9a-fA-F]{40}$/.test(address)) return ui('Please enter a valid 0x…40‑hex contract address.', 'err');

  // Build multipart form: /server/verify expects files[] with "contracts/<file>.sol"
  const form = new FormData();
  const fileName = 'contracts/AssetsAlertNFT_FINAL_FIXED.sol';
  form.append('address', address);
  form.append('chain', chain);
  form.append('compiler', compiler);
  // Fully qualified name helps Sourcify pick the right contract within the file:
  form.append('contract', `${fileName}:${name}`);
  // Add the Solidity file as a Blob
  form.append('files', new Blob([source], { type: 'text/plain' }), fileName);

  ui('Submitting to Sourcify… Please wait 10–30 seconds.');
  try {
    const res = await fetch('https://sourcify.dev/server/verify', { method:'POST', body: form });
    const text = await res.text();
    try {
      const json = JSON.parse(text);
      ui('Sourcify response:\n' + JSON.stringify(json, null, 2), json.ok ? 'ok' : '');
    } catch {
      ui('Sourcify raw response:\n' + text);
    }
  } catch (err) {
    ui('Network error: ' + err.message, 'err');
  }
}

async function checkStatus(){
  const address = document.getElementById('address').value.trim();
  const chain   = document.getElementById('chain').value.trim();
  if (!/^0x[0-9a-fA-F]{40}$/.test(address)) return ui('Please enter a valid 0x…40‑hex contract address.', 'err');

  ui('Checking status…');
  try {
    const url = `https://sourcify.dev/server/check-all-by-addresses?addresses=${address}&chainIds=${chain}`;
    const res = await fetch(url, {cache:'no-store'});
    const json = await res.json();
    const status = JSON.stringify(json, null, 2);
    const human = (() => {
      try {
        const entry = json[0] || {};
        const st = (entry.status || '').toLowerCase();
        if (st) return `Status: ${st}`;
      } catch {}
      return 'See JSON below.';
    })();
    ui(human + '\n\n' + status, 'ok');
  } catch (err) {
    ui('Status check failed: ' + err.message, 'err');
  }
}

document.getElementById('verifyBtn').addEventListener('click', verifyWithSourcify);
document.getElementById('checkBtn').addEventListener('click', checkStatus);
</script>
</body>
</html>
